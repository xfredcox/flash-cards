<polymer-element name="flash-cards" attributes="data">
    <template>

	
	<style>
	 
	 .noselect {
	     -webkit-touch-callout: none;
	     -webkit-user-select: none;
	     -khtml-user-select: none;
	     -moz-user-select: none;
	     -ms-user-select: none;
	     user-select: none;
	 }
	 
	 #container {
	     max-width: 400px;
	     height: 400px;
	     padding: 0px;
	     margin: 20px;
	     border: solid black 1px;
	 }

	 #header {
	     width: 100%;
	     height: 12px;
	     font-size: 10px;
	     background-color: steelblue;
	     color: #eee;
	     text-align: center;
	     border: solid black 1px;
	 }
	 #question {
	     overflow: scroll;	     
	     width: 90%;
	     height: 100px;
	     border: solid black 1px;
	     text-align: center;
	     line-height: 100px;
	     padding-left: 5%;
	     padding-right: 5%;	   	   	   
	 }
	 #answer {
	     overflow: scroll;
	     width: 90%;
	     height: 283px;
	     border: solid black 1px;
	     text-align: center;
	     line-height: 283px;
	     padding-left: 5%;
	     padding-right: 5%;	   	   
	 }
	 .middle {
	     display: inline-block;
	     vertical-align: middle;
	     line-height: normal;  
	 }
	 
	</style>
	
	<div id="container" class="noselect">

	    <div id="header">
		{{name}} - {{N ? n + 1 : n}}/{{N}}
	    </div>

	    <div id="workspace" on-click="{{next}}">

		<div id="question">
		    <span id="question_content" class="middle"></span>
		</div>

		<div id="answer">
		    <span id="answer_content" class="middle" hidden?="{{!showState}}"></span>
		</div>	 

	    </div>
	</div>

	
    </template>
    <script>
     (function () {
	 'use strict';

	 Polymer({
	     log: true,
	     computed: {
		 "N": "cards.length",
	     },
	     n: 0,
	     cards: [],
	     name: "Flashcards",
	     showState: false,
	     dataChanged: function () {
		 this.log ? console.log("<flash-cards> dataChanged *start*") : null;

		 // Parse if necessary
		 if (typeof this.data == "string") {
		     var _data = JSON.parse(this.data);
		 } else {
		     var _data = this.data;
		 }
		 
		 // Reset Values
		 this.name = _data && _data.name ? _data.name : this.name;
		 this.cards = _data && _data.cards ? _data.cards : this.cards;
		 this.showState = false;
		 this.n = 0;
		 this.nChanged();
		 
		 this.log ? console.log("<flash-cards> dataChanged *finish*") : null;
	     },

	     nChanged: function () {
		 this.log ? console.log("<flash-cards> nChanged *start*") : null;

		 // Reset Values
		 this.showState = false;
		 this.question = this.renderMarkdown(this.cards[this.n].question);
		 this.answer = this.renderMarkdown(this.cards[this.n].answer);		

		 // Inject the HTML output into the respective element
		 this.injectBoundHTML(this.question, this.$.question_content);
		 this.injectBoundHTML(this.answer, this.$.answer_content);		     		
		 
		 this.log ? console.log("<flash-cards> nChanged *finish*") : null;
	     },
	     next: function () {

		 if (this.showState) {
		     if (this.n + 1 == this.N) {
			 this.n = 0;
		     } else {
			 this.n += 1;
		     }
		 } else {
		     this.showState = true;
		 }
	     },
	     renderMarkdown: function (text) {
		 this.log ? console.log("<flash-cards> renderMarkdown *start*") : null;

		 this.log ? console.log("<flash-cards> renderMarkdown <text> " + text) : null;		 
		 // edge case: empty content
		 if (text == '') {
		     return ""
		 }

		 // parse the markdown into a tree and grab the link references
		 
		 var tree = markdown.parse( text );

		 function recur (row) {
		     
		     if ( row[0] === "inlinecode" ) {
			 var lang = row[1].match(/^.+\n/g);
			 var n = 0;
			 if (lang == null) {
			     lang = ["*\n"];
			     n = 1;
			 }
			 var code = row[1].slice(lang[0].length-n);
			 
			 row[0] = "inlinecode"
			 row[1] = {'language':lang[0].slice(0,lang[0].length-1)}
			 row.push(code)
			     
		     } else {
			 row.forEach(function (sub) {
			     if (Array.isArray(sub)) {
				 recur(sub);
			     }
			 })
		     }
		     
		 }

		 recur(tree)

		     // convert the tree into html
		 var html = markdown.renderJsonML( markdown.toHTMLTree( tree ) );

		 this.log ? console.log("<flash-cards> renderMarkdown <html> " + html) : null;		 		 
		 this.log ? console.log("<flash-cards> renderMarkdown *finish*") : null;		

		 return html
	     },
	     
	     ready: function () {
		 this.log ? console.log("<flash-cards> ready *start*") : null;


		 this.log ? console.log("<flash-cards> ready *finish*") : null;
	     },
	     domReady: function () {
		 this.log ? console.log("<flash-cards> domReady *start*") : null;

		 

		 this.log ? console.log("<flash-cards> domReady *finish*") : null;
	     },	    	    
	 })
	     
     })()
    </script>
</polymer-element>
